<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<title>Spaceshits &mdash; A 2D Top-Down Space Shooter</title>
		<link rel="stylesheet" href="./base.css" />
		<link rel="stylesheet" href="./application.css" />
		<script src="./extensions.js"></script>
		<script src="./engine.js"></script>
		<script src="./game.js"></script>
		<script>
			const ScreenCenter = {
				screens: new Map(),
				currentScreen: null,

				add(screen, onEnter, onExit) {
					this.screens.set(screen, { onEnter, onExit })
				},

				navigateTo(screen) {
					if (this.currentScreen) {
						this.currentScreen.classList.add("disabled")

						const onExit = this.screens.get(this.currentScreen).onExit
						onExit && onExit()
					}

					screen.classList.remove("disabled")

					const onEnter = this.screens.get(screen).onEnter
					onEnter && onEnter()

					this.currentScreen = screen
				}
			}

			const SettingsCenter = {
				moveUpBoundKey: "KeyW",
				moveLeftBoundKey: "KeyA",
				moveDownBoundKey: "KeyS",
				moveRightBoundKey: "KeyD",
				shootBoundKey: "MouseLeft",
				useSpecialBoundKey: "Space",
				togglePauseBoundKey: "Escape"
			}

			const mouseButtonLabels = [ "MouseLeft", "MouseMiddle", "MouseRight" ]

			const GameCenter = {
				currentLevel: 1,
				lastLevel: 25,

				newUniverse(canvas) {
					const universe = new Universe()

					universe[Global.keyMoveUp] = SettingsCenter.moveUpBoundKey
					universe[Global.keyMoveLeft] = SettingsCenter.moveLeftBoundKey
					universe[Global.keyMoveDown] = SettingsCenter.moveDownBoundKey
					universe[Global.keyMoveRight] = SettingsCenter.moveRightBoundKey
					universe[Global.keyShoot] = SettingsCenter.shootBoundKey
					universe[Global.keySpecial] = SettingsCenter.useSpecialBoundKey

					universe[Global.canvas] = canvas
					universe[Global.graphics] = canvas.getContext("2d")
					universe[Global.userInteraction] = universe.add(UserInteractor).UserInteraction
					universe.add(CanvasEraser)
					universe.add(InteractionLogger)
					universe.add(Player, 0.5 * canvas.width, 0.7 * canvas.height)

					return universe
				}
			}
		</script>
	</head>
	<body>
		<div id="mainScreen" class="screen disabled">
			<header class="screen-header">
				<h1 class="screen-title">
					<span>Spaceshits</span>
					<small>Advertizing Dirty Code in Tablets.</small>
				</h1>
			</header>
			<main class="screen-content centering-element">
				<div id="newGameActionCard" class="action-card interactible-element red iconic-element plus">
					<span>New Game</span>
				</div>
				<div id="resumeLastGameActionCard" class="action-card interactible-element teal iconic-element right-chevron">
					<small>Resume</small>
					<span>Last Game</span>
				</div>
				<div id="editSettingsActionCard" class="action-card interactible-element purple iconic-element gear">
					<span>Edit Settings</span>
				</div>
			</main>
		</div>
		<script> ;(function () {
			ScreenCenter.add(mainScreen, _enter => {
				if (1 < GameCenter.currentLevel) {
					resumeLastGameActionCard.classList.remove("disabled")
				} else {
					resumeLastGameActionCard.classList.add("disabled")
				}
			})

			newGameActionCard.addEventListener("click", _ => {
				GameCenter.currentLevel = 1
				ScreenCenter.navigateTo(lobbyScreen)
			}, false)
			resumeLastGameActionCard.addEventListener("click", _ => ScreenCenter.navigateTo(lobbyScreen), false)
			editSettingsActionCard.addEventListener("click", _ => ScreenCenter.navigateTo(settingsScreen), false)
		})(); </script>

		<!-- ================================================================= -->

		<div id="settingsScreen" class="screen disabled">
			<header class="screen-header">
				<h1 class="screen-title">
					<span>Settings</span>
					<small>Hover Over the Fields and Press Keys to Edit Them.</small>
				</h1>
			</header>
			<main class="screen-content centering-element">
				<div class="lifting-element">
					<div id="discardChangesActionCard" class="action-card interactible-element blue iconic-element cross">
						<span>Discard Changes</span>
					</div>
					<section class="key-binding-grid">
						<div class="key-binding-item interactible-element teal" style="grid-row-start: 1; grid-column-start: 3;">
							<div class="label">Move Up</div>
							<span id="moveUpBind">...</span>
						</div>
						<div class="key-binding-item interactible-element teal" style="grid-row-start: 2; grid-column-start: 2;">
							<div class="label">Move Left</div>
							<span id="moveLeftBind">...</span>
						</div>
						<div class="key-binding-item interactible-element teal" style="grid-row-start: 3; grid-column-start: 3;">
							<div class="label bottom">Move Down</div>
							<span id="moveDownBind">...</span>
						</div>
						<div class="key-binding-item interactible-element teal" style="grid-row-start: 2; grid-column-start: 4;">
							<div class="label">Move Right</div>
							<span id="moveRightBind">...</span>
						</div>
						<div class="key-binding-item interactible-element yellow" style="grid-row-start: 1; grid-column-start: 5;">
							<div class="label">Shoot</div>
							<span id="shootBind">...</span>
						</div>
						<div class="key-binding-item interactible-element blue" style="grid-row-start: 3; grid-column-start: 5;">
							<div class="label bottom">Use Special</div>
							<span id="useSpecialBind">...</span>
						</div>
						<div class="key-binding-item interactible-element purple" style="grid-row-start: 1; grid-column-start: 1;">
							<div class="label">Toggle Pause</div>
							<span id="togglePauseBind">...</span>
						</div>
						<div class="iconic-element ship" style="grid-row-start: 2; grid-column-start: 3;"></div>
						<div class="iconic-element bullet" style="grid-row-start: 2; grid-column-start: 5;"></div>
					</section>
					<div id="saveChangesActionCard" class="action-card interactible-element pink iconic-element right-chevron">
						<span>Save Changes</span>
					</div>
				</div>
			</main>
		</div>
		<script> ;(function () {
			let focus = null

			for (const bindElement of [
				moveUpBind,
				moveLeftBind,
				moveDownBind,
				moveRightBind,
				shootBind,
				useSpecialBind,
				togglePauseBind
			]) {
				bindElement.parentElement.addEventListener("mouseenter", _ => focus = bindElement, false)
				bindElement.parentElement.addEventListener("mouseleave", _ => focus = null, false)
			}

			function bindToKey(event) { focus && (focus.textContent = event.code) }
			function bindToMouseButton(event) { focus && (focus.textContent = mouseButtonLabels[event.button]) }

			ScreenCenter.add(settingsScreen, _enter => {
				loadKeyBindings()

				document.addEventListener("keydown", bindToKey, false)
				document.addEventListener("mousedown", bindToMouseButton, false)
			}, _exit => {
				document.removeEventListener("keydown", bindToKey, false)
				document.removeEventListener("mousedown", bindToMouseButton, false)
			})

			discardChangesActionCard.addEventListener("click", _ => ScreenCenter.navigateTo(mainScreen), false)
			saveChangesActionCard.addEventListener("click", _ => {
				saveKeyBindings()

				ScreenCenter.navigateTo(mainScreen)
			}, false)

			function loadKeyBindings() {
				moveUpBind.textContent = SettingsCenter.moveUpBoundKey
				moveLeftBind.textContent = SettingsCenter.moveLeftBoundKey
				moveDownBind.textContent = SettingsCenter.moveDownBoundKey
				moveRightBind.textContent = SettingsCenter.moveRightBoundKey
				shootBind.textContent = SettingsCenter.shootBoundKey
				useSpecialBind.textContent = SettingsCenter.useSpecialBoundKey
				togglePauseBind.textContent = SettingsCenter.togglePauseBoundKey
			}

			function saveKeyBindings() {
				SettingsCenter.moveUpBoundKey = moveUpBind.textContent
				SettingsCenter.moveLeftBoundKey = moveLeftBind.textContent
				SettingsCenter.moveDownBoundKey = moveDownBind.textContent
				SettingsCenter.moveRightBoundKey = moveRightBind.textContent
				SettingsCenter.shootBoundKey = shootBind.textContent
				SettingsCenter.useSpecialBoundKey = useSpecialBind.textContent
				SettingsCenter.togglePauseBoundKey = togglePauseBind.textContent
			}
		})(); </script>

		<!-- ================================================================= -->

		<div id="lobbyScreen" class="screen disabled">
			<header class="screen-header">
				<h1 class="screen-title">
					<span>Spaceshits</span>
					<small>Ready to Go Back?</small>
				</h1>
			</header>
			<main class="screen-content centering-element">
				<div id="goBackActionCard" class="action-card interactible-element teal iconic-element cross">
					<span>Flee</span>
				</div>
				<div id="nextLevelActionCard" class="action-card interactible-element red iconic-element right-chevron">
					<span>Enter Arena #<span id="arenaLevelSpan"></span></span>
				</div>
			</main>
		</div>
		<script> ;(function () {
			ScreenCenter.add(lobbyScreen, _enter => {
				arenaLevelSpan.textContent = GameCenter.currentLevel
			})

			nextLevelActionCard.addEventListener("click", _ => ScreenCenter.navigateTo(inGameScreen), false)
			goBackActionCard.addEventListener("click", _ => ScreenCenter.navigateTo(mainScreen), false)
		})(); </script>

		<!-- ================================================================= -->

		<div id="inGameScreen" class="screen disabled">
			<main class="screen-content centering-element">
				<div class="game-canvas-wrapper interactible-element grey" style="height: 716px">
					<canvas id="gameCanvas" class="game-canvas" width="700" height="700" tabindex="1"></canvas>
				</div>
			</main>
		</div>
		<script> ;(function () {
			let universe = null

			ScreenCenter.add(inGameScreen, _enter => {
				universe = universe || GameCenter.newUniverse(gameCanvas)

				gameCanvas.focus()
				universe.run()

				Promise.delay(3000)
					.then(_ => playLevel(universe, GameCenter.currentLevel))
					.then(victory => Promise.delay(3000, victory))
					.then(victory => {
						if (victory) {
							ScreenCenter.navigateTo(GameCenter.currentLevel == GameCenter.lastLevel ? victoryScreen : rewardScreen)
						} else {
							ScreenCenter.navigateTo(defeatScreen)
						}
					})
			}, _exit => {
				universe && universe.freeze()
				universe = null
			})

			gameCanvas.addEventListener("mousedown", event => {
				gameCanvas.focus()

				if (universe && mouseButtonLabels[event.button] == SettingsCenter.togglePauseBoundKey) {
					universe.isRunning ? universe.freeze() : universe.run()
				}
			}, false)

			gameCanvas.addEventListener("keydown", event => {
				if (universe && event.code == SettingsCenter.togglePauseBoundKey) {
					universe.isRunning ? universe.freeze() : universe.run()
				}
			}, false)

			function playLevel(universe, currentLevel) {
				for (let i = 0; i < currentLevel; ++i) {
					universe.add(
						randBetween(ZombieCube, AkimboCube, CrossCube, HighSpeedCube, SplittingCube, CubeFactory),
						rand(0, universe[Global.canvas].width),
						rand(0, universe[Global.canvas].height)
					)
				}

				return new Promise(resolve => {
					universe.add(class ArenaMonitor extends Link{
						onInitialize() {
							const player = getFirst(universe, Tag.player)

							this.add(class ArenaMonitoring extends Trait {
								onUpdate() {
									if (player.Destroyable.health < 0) {
										this.stop = true
										resolve(false)
									} else if (getFirst(universe, Tag.enemy) == null) {
										this.stop = true
										resolve(true)
									}
								}

								onRemoving() {
									return this.stop
								}
							})
						}
					})
				})
			}

			function getFirst(universe, tag) {
				for (const link of universe.links) {
					if (link[tag]) {
						return link
					}
				}

				return null
			}
		})(); </script>

		<!-- ================================================================= -->

		<div id="rewardScreen" class="screen disabled">
			<header class="screen-header">
				<h1 class="screen-title">
					<span>Reward</span>
					<small>Select Your Prise.</small>
				</h1>
			</header>
			<main class="screen-content centering-element">
				<div id="selectRewardActionCard" class="action-card interactible-element orange iconic-element right-chevron">
					<span>Continue</span>
				</div>
			</main>
		</div>
		<script> ;(function () {
			ScreenCenter.add(rewardScreen, _enter => ++GameCenter.currentLevel)

			selectRewardActionCard.addEventListener("click", _ => ScreenCenter.navigateTo(lobbyScreen), false)
		})(); </script>

		<!-- ================================================================= -->

		<div id="victoryScreen" class="screen disabled">
			<header class="screen-header">
				<h1 class="screen-title">
					<span>Victory</span>
					<small>Impossible!</small>
				</h1>
			</header>
			<main class="screen-content centering-element">
				<div id="takePrideActionCard" class="action-card interactible-element yellow iconic-element right-chevron">
					<span>Take the Pride</span>
				</div>
			</main>
		</div>
		<script> ;(function () {
			ScreenCenter.add(victoryScreen, _enter => GameCenter.currentLevel = 1)

			takePrideActionCard.addEventListener("click", _ => ScreenCenter.navigateTo(mainScreen), false)
		})(); </script>

		<!-- ================================================================= -->

		<div id="defeatScreen" class="screen disabled">
			<header class="screen-header">
				<h1 class="screen-title">
					<span>Defeat</span>
					<small>They Never Last Long Enough...</small>
				</h1>
			</header>
			<main class="screen-content centering-element">
				<div id="assumeShameActionCard" class="action-card interactible-element pink iconic-element right-chevron">
					<span>Assume the Shame</span>
				</div>
			</main>
		</div>
		<script> ;(function () {
			ScreenCenter.add(defeatScreen, _enter => GameCenter.currentLevel = 1)

			assumeShameActionCard.addEventListener("click", _ => ScreenCenter.navigateTo(mainScreen), false)
		})(); </script>

		<!-- ================================================================= -->

		<script>
			ScreenCenter.navigateTo(mainScreen)
		</script>
	</body>
</html>
